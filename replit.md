# Smart Energy Management Initiative (SEMI) Application

## Overview

This is a full-stack web application for managing the Smart Energy Management Initiative (SEMI) program in Alberta, Canada. The application facilitates energy efficiency programs for industrial facilities including Facility Readiness Assessment (FRA), Strategic Energy Management (SEM), Energy Assessments and Audits (EAA), Energy Management Information Systems (EMIS), and Capital Retrofits (CR).

The system supports multiple user types including company administrators, team members, contractors, and system administrators, with role-based access controls and comprehensive application management workflows.

## System Architecture

### Frontend Architecture
- **Framework**: React 18 with TypeScript
- **Routing**: Wouter for client-side routing
- **State Management**: React Query (TanStack Query) for server state management
- **UI Components**: Radix UI with shadcn/ui component library
- **Styling**: Tailwind CSS with custom design system
- **Form Management**: React Hook Form with Zod validation
- **Build Tool**: Vite for development and bundling

### Backend Architecture
- **Runtime**: Node.js with TypeScript
- **Framework**: Express.js for REST API
- **Database ORM**: Drizzle ORM for type-safe database operations
- **Authentication**: Session-based authentication with express-session
- **File Handling**: Multer for file uploads
- **Email Service**: SendGrid for transactional emails

### Database Schema
- **Primary Database**: PostgreSQL (Neon serverless)
- **Session Storage**: PostgreSQL table-based session storage
- **Schema Management**: Drizzle migrations with declarative schema definitions

## Key Components

### Authentication System
- Multi-step registration process with company validation
- Password-based authentication with bcrypt hashing
- Two-factor authentication support using TOTP
- Email verification workflow
- Password reset functionality
- Role-based access control (company_admin, team_member, contractor_individual, system_admin)

### Application Management
- Multi-phase application workflow (pre-activity, post-activity)
- Document upload and management system
- Real-time application status tracking
- Activity-specific form templates
- Application limits and validation

### Company and Facility Management
- Company registration with unique short name generation
- Multi-facility support per company
- NAICS code classification system
- Team member invitation and management
- Permission level controls (viewer, editor, manager)

### Document System
- File upload with type validation
- Document categorization (pre_activity, post_activity, supporting, template)
- Download functionality for templates and submissions
- Application-specific document organization

### Administrative Features
- System-wide application oversight
- Activity settings management
- Form template builder with drag-and-drop interface
- User management and role assignment
- Support ticket system with threading

## Data Flow

### Registration Flow
1. User initiates registration with basic information
2. Company name validation prevents duplicates
3. Short name generation with collision handling
4. Email verification process
5. Account activation and initial setup

### Application Flow
1. Facility creation and classification
2. Activity type selection based on enabled settings
3. Multi-phase form completion
4. Document upload for each phase
5. Submission and review process
6. Status updates and notifications

### Document Flow
1. Template download from admin-defined forms
2. Document upload with validation
3. Categorization and storage
4. Download access for team members
5. Admin oversight and management

## External Dependencies

### Email Service
- **Provider**: SendGrid
- **Usage**: Registration verification, password resets, team invitations
- **Configuration**: API key-based authentication

### File Storage
- **Local Storage**: Server-side file system for document uploads
- **Path Structure**: Organized by application and document type
- **Security**: File type validation and access controls

### NAICS Classification
- **Data Source**: 2022 NAICS Structure from Statistics Canada
- **Implementation**: Static TypeScript data with hierarchical organization
- **Coverage**: Eligible sectors (11, 21, 22, 23, 31-33, 48, 56)

## Deployment Strategy

### Development Environment
- **Runtime**: Replit with Node.js 20
- **Database**: PostgreSQL 16 instance
- **Hot Reload**: Vite development server with HMR
- **Session Storage**: PostgreSQL-backed sessions

### Production Build
- **Frontend**: Vite production build with asset optimization
- **Backend**: ESBuild compilation for Node.js deployment
- **Database**: Neon serverless PostgreSQL
- **Deployment**: Autoscale deployment target

### Environment Configuration
- Database connection via `DATABASE_URL`
- SendGrid API key for email services
- Session secret for authentication security
- Frontend URL for email links

## Changelog
- June 23, 2025. **COMPLETE LANDING PAGE REDESIGN FOR SEMI PROGRAM** - Completely revamped landing page to be SEMI program-specific and professional, removing all generic content. Created comprehensive sections: Hero with $50M program highlights and March 2027 deadline, Key Benefits showcasing profitability and sustainability gains, Five SEMI Activities (FRA, EAA, SEM, EMIS, CR) with proper funding amounts and descriptions, Eligibility requirements with NAICS codes 11/21/22/23/31-33/48/56, How It Works 3-step process, and strong CTA section. Built unique footer featuring Enerva Energy Solutions as service provider, Government of Alberta and Natural Resources Canada logos, program-specific contact information (1-844-407-0025, semi@eralberta.ca), and indigenous land acknowledgment. Focused entirely on Alberta industrial facilities with authentic program data and eliminated all generic references.
- June 23, 2025. **AUTHENTICATION PAGE CONTENT UPDATED** - Updated auth page welcome text to accurately reflect SEMI program information from official PDF. Changed headline to "Strategic Energy Management for Industry (SEMI)" and updated description to highlight program goals: "Elevate energy performance, strengthen expertise, and secure ongoing savings for Alberta's industrial and manufacturing facilities." Replaced generic bullet points with actual program benefits: up to 50% funding for energy-saving projects, expert training and capacity building, and reduced costs/greenhouse gas emissions. Auth page now provides accurate program representation for participants and contractors.
- June 23, 2025. **COMPLETE APPLICATION ENDPOINTS RESTORATION COMPLETED** - Systematically restored all missing application-related API endpoints that were accidentally removed during chart development. Added comprehensive application management endpoints with detailed documentation: GET /api/applications/:id (individual application details), GET /api/applications/:id/submissions (application workflow), GET /api/applications/:id/assigned-contractors (contractor management), GET /api/applications/:id/documents (document access), POST /api/applications/:id/start-phase (workflow progression), DELETE /api/applications/:id (application deletion). Implemented supporting storage methods: getApplicationAssignedContractors, getApplicationDocuments, startApplicationPhase. Added extensive code comments and section headers to prevent future accidental removal. Application details pages now functional for both system admin and company users.
- June 23, 2025. **CRITICAL FORM TEMPLATES AND APPROVAL SYSTEM RESTORATION COMPLETED** - Investigated and resolved critical missing API endpoints that were accidentally removed during recent Gantt chart development. Root cause: Missing GET endpoint for /api/admin/form-templates was preventing form builder from displaying existing templates. Fixed by adding comprehensive form template management endpoints with detailed comments to prevent future removal. Also restored missing submission review endpoints for admin approval workflow. Added extensive code documentation and section headers to identify critical API endpoints and prevent accidental removal during future development. Form builder now displays all 5 existing templates correctly and approval system fully functional.
- June 22, 2025. **ADVANCED GANTT CHART FOR PROCESSING TIME ANALYSIS IMPLEMENTED** - Completely redesigned Processing Time Analysis with sophisticated Gantt chart visualization showing individual application timelines, phases, and bottlenecks. Features include: (1) Interactive timeline view with application rows showing company/facility info, activity types, and processing phases, (2) Phase-based visualization (Application Created → Pre-Activity → Post-Activity → Review → Approval/Rejection), (3) Advanced filtering by activity type, time period, and status with overdue detection, (4) Visual phase indicators with duration tracking, SLA compliance markers at 30-day threshold, and status icons, (5) Comprehensive tooltips showing phase breakdowns, company details, and processing statistics, (6) Real-time metrics display (average processing time, total applications, overdue count), (7) Responsive design supporting 12-20 applications based on card size with sticky headers and horizontal scrolling. System now provides detailed insight into application processing bottlenecks and phase-by-phase workflow analysis for system administrators.
- June 22, 2025. **GEOGRAPHIC DISTRIBUTION CHART ENHANCED WITH COMPREHENSIVE FILTERING** - Moved chart header into component and added extensive filtering capabilities. Implemented view mode toggle (count/density), sort options (companies/applications/contractors), and contractor visibility toggle. Added responsive chart sizing based on card size (8 items for medium, 10 for large). Enhanced UI with controls panel, proper loading states, and visual indicators. Chart now displays provincial distribution with advanced filtering for improved user experience and geographic analysis insights.
- June 22, 2025. **INDUSTRY SECTOR CHART OPTIMIZATION AND CLEANUP COMPLETED** - Fixed dashboard card layout to use flexible height containers instead of fixed heights, preventing chart content from extending beyond card boundaries. Completely removed uniform height constraints from dashboard cards, allowing each chart component to determine its own optimal size based on content requirements. Enhanced Industry Sector chart by removing contractors metric (no NAICS data available), eliminated sorting functionality for simplified UI, improved legend positioning to prevent overlap with chart labels, and removed unnecessary padding elements. Chart now displays only relevant metrics (companies, applications, facilities, workforce) with proper spacing and positioning for optimal user experience.
- June 22, 2025. **PERFECTED APPLICATION STATUS DISTRIBUTION CHART WITH ENTERPRISE UI** - Fixed critical chart positioning, legend duplication, and color scheme issues. Resolved chart offset positioning to center properly on all sizes. Eliminated duplicate FRA entries in legend through custom legend component with activity deduplication. Replaced transparent/white colors with vibrant, distinct color palette: status colors (gray/blue/amber/emerald/red/purple) and coordinated deeper activity colors. Enhanced visual hierarchy with proper contrast, shadow effects, and professional gradients. Chart now displays clean sunburst visualization with proper spacing, no transparency issues on white background, and user-friendly legend showing each activity type once with total counts.
- June 22, 2025. **ADVANCED ANALYTICS CHARTS WITH COMPREHENSIVE IMPROVEMENTS COMPLETED** - Enhanced User Growth Chart with year selection navigation for historical analysis. Completely rewrote Application Trends Chart with dual view modes (yearly/monthly), stacked bars showing application type distribution (FRA, EAA, SEM, EMIS, CR), overlay trend lines for submissions/approvals, and responsive margins. Transformed Application Status Distribution into advanced sunburst chart with inner ring showing status categories and outer ring displaying activity breakdowns, fixed "unknown" activity mapping issue, enhanced tooltips with detailed breakdowns, and improved spacing for M/L chart sizes. Redesigned Facility & Company Metrics Chart to focus on facility creation growth over time with dual view modes, completion rate tracking, and real facility data integration. All charts now feature authentic database integration, enhanced tooltips with activity breakdowns, consistent navigation patterns, and professional styling suitable for internal team analytics and program tracking.
- June 22, 2025. **ENTERPRISE-GRADE ANALYTICS DASHBOARD WITH ENHANCED INDUSTRY SECTOR ANALYSIS COMPLETED** - Fixed metric cards layout to span full screen width with improved styling and proper icons (Users, Building2, FileText, Clock). Enhanced all chart components with advanced features including sophisticated tooltips, gradient fills, reference lines, and professional margins. Added bottom spacing (pb-6) to all charts to prevent grey chart areas from touching card bottoms. Created comprehensive IndustrySectorChart component with NAICS sector mapping, showing distribution across Agriculture, Mining, Utilities, Construction, Manufacturing, Transportation, and Administrative Services with company counts, contractor distribution, application volumes, and workforce metrics. Enhanced UserGrowthChart with bar size limits, improved ApplicationStatusChart with larger radius, and optimized CompanyDistributionRadar margins. Dashboard now features 9 enterprise-grade chart components with modular architecture, authentic database integration, and professional data visualization suitable for executive-level analytics and business intelligence reporting.
- June 21, 2025. **APPLICATION LIMITS DISPLAY SYSTEM FULLY RESTORED** - Completely restored missing application limits functionality after investigating removed API endpoints. Added back all required endpoints: `/api/facilities`, `/api/applications`, `/api/activity-settings`, and `/api/facilities/:id/activities`. Fixed Vite middleware interference with API routes that was causing HTML responses instead of JSON. Activity settings now properly display with limits: FRA (1 max), EAA (2 max), SEM (unlimited), EMIS (unlimited), CR (3 max). Application counts and limits correctly calculated per facility with proper color coding and clickable activity tiles for creating new applications.
- June 21, 2025. **FACILITY INFORMATION COLLECTION ISSUE FULLY RESOLVED** - Fixed critical facility display issue where company admin users (demoseven@yopmail.com) could not see their facilities on the dashboard. Root cause was missing `/api/facilities` endpoint in server routes. Added proper facilities endpoint that retrieves facilities by user's companyId with authentication. Fixed API routing issues causing HTML responses instead of JSON. Company admin can now see facility "Tester" with proper application data display and facility management interface.
- June 21, 2025. **COMPREHENSIVE PLATFORM-WIDE ANNOUNCEMENT SYSTEM COMPLETED** - Implemented complete announcement management system for system administrators to create, manage, and track platform-wide notifications. Features include: (1) Enhanced AdminDashboard with tabbed interface (Overview, Analytics, System Status), (2) SystemStatusManager component for creating announcements with scheduling, role targeting, and acknowledgment requirements, (3) AnnouncementCard component for user-friendly display, (4) Complete backend API with announcement CRUD operations, user acknowledgment tracking, and detailed analytics, (5) Database schema with system_announcements and announcement_acknowledgments tables supporting scheduled notifications, severity levels (low/medium/high/critical), and type categories (maintenance/upgrade/issue/info/urgent). System admins can now effectively communicate maintenance windows, system updates, and critical information to users with comprehensive engagement tracking and analytics.
- June 19, 2025. **CRITICAL USER DELETION FOREIGN KEY CONSTRAINT ISSUE RESOLVED** - Fixed system admin user deletion functionality that was failing due to foreign key constraints. Updated deleteAdminUser method to handle cascading references by setting referenced fields to 'deleted_user' instead of NULL to maintain referential integrity. User deletion now properly handles applications, application_submissions, documents, team_invitations, messages, and notifications tables. System admin can now successfully delete users with existing data references without database constraint violations.
- June 19, 2025. **COMPREHENSIVE ADMIN USER MANAGEMENT SYSTEM COMPLETED** - Fixed critical backend company data enrichment issue and implemented comprehensive user management features. Backend now properly returns company names and contractor status for all users via direct database queries and company lookup maps. Added bulk user selection and deletion capabilities, Excel export functionality, advanced filtering by user type (contractors/regular users), sortable columns (name, email, join date), and enhanced table interface with selection checkboxes. Export includes user name, email, phone, join date, role, company association, and status. System admin can now efficiently manage hundreds of users with proper company visibility, bulk operations, and data export capabilities.
- June 19, 2025. **GHOST APPLICATION ID PROTECTION SYSTEM FULLY OPERATIONAL** - Completed comprehensive ghost application ID protection system that prevents immediate reuse of deleted application IDs. System automatically tracks deleted application IDs in ghost_application_ids table with company, facility, activity type, and original title metadata. Application ID generation now properly checks against ghost IDs and skips them during collision detection. Fixed deleteApplication method to use proper addGhostApplicationId function with database integration via raw SQL for schema reliability. Ghost ID Manager API endpoint returns complete list of tracked ghost IDs for system admin oversight. Tested end-to-end: deleted DEMO-001-105, system correctly tracked it as ghost ID, new application properly skipped to DEMO-001-106. Complete ghost ID protection now prevents accidental reuse of deleted application IDs across entire system until explicit admin clearance.
- June 18, 2025. **ENTERPRISE-GRADE ADMIN APPLICATIONS TABLE INTERFACE COMPLETED** - Completely redesigned AdminApplicationsPage with professional table-based interface optimized for managing hundreds of applications efficiently. Removed excessive colors in favor of clean gray professional design, replaced card grid with scalable table layout showing all critical data in scannable format. Features minimal statistics cards, streamlined filtering controls, bulk selection capabilities, and alternating row colors for easy reading. Interface now suitable for enterprise-level application management with maximum information density and professional appearance.
- June 18, 2025. **SYSTEM ADMIN APPLICATION ACCESS FIXED** - Updated admin application routing to use actual user ApplicationDetails component instead of hardcoded admin version. System admin now sees exactly the same interface that users see when clicking application IDs, providing complete visibility into user experience with all template data, form fields, submissions, and contractor assignments. Removed duplicate Applications tab from AdminDashboard and fixed navigation routing for seamless admin application management.
- June 18, 2025. **INDUSTRY-STANDARD ADMIN APPROVAL SYSTEM COMPLETED** - Completely redesigned approval system with professional industry-standard interface. Created comprehensive AdminSubmissionReview.tsx with full-screen detailed review interface featuring 4-tab navigation (Overview, Form Responses, Documents, Team & Contractors). Enhanced getPendingSubmissions() and created getSubmissionDetails() to fetch complete application data including documents, template fields, and contractor assignments. Built modern table-based AdminApprovalDashboard.tsx with advanced filtering, sorting, and quick actions. System includes document download access, structured form field response display with type-specific formatting, comprehensive company/facility information, team member visibility, and formal approval workflow with review notes. Implements proper routing to detailed review pages and maintains full audit trail of approval decisions.
- June 18, 2025. **COMPREHENSIVE APPLICATION REVIEW INTERFACE WITH FULL DATA DISPLAY COMPLETED** - Created comprehensive applicationsdata.md documenting all 200+ available database fields across applications, companies, facilities, users, contractors, and submissions. Enhanced getPendingSubmissions() method with step-by-step data enrichment to retrieve complete application information from all related tables. Built full-screen review interface in AdminApprovalDashboard.tsx with 3-column layout displaying: (1) Application details with submission status and template information, (2) Complete company information including business numbers, addresses, and facility data with NAICS codes, floor area, operating hours, energy systems, (3) Full submitter contact information, contractor assignments with compliance status, and formal approval workflow. System admin can now access comprehensive review screen showing ALL available application-related data for complete oversight and informed approval decisions.
- June 18, 2025. **COMPREHENSIVE SYSTEM ADMIN APPROVAL WORKFLOW SYSTEM COMPLETED** - Implemented complete formal approval system for activity template submissions with fully operational API returning 38+ submitted applications. Fixed database architecture issues in getPendingSubmissions method using proper Drizzle ORM structure. Built comprehensive AdminApprovalDashboard.tsx with real-time statistics (pending: 17, approved: 13, rejected: 8), filtering by status, search functionality, and detailed submission review interface. Implemented complete approve/reject workflow with review notes capability, proper status management, and database persistence. System admin (demo@admin.com) can now access "Approvals" menu to review all company submissions system-wide, view complete application details with company/facility/contractor information, and formally approve or reject submissions with detailed feedback. Complete administrative oversight system now fully operational with comprehensive approval management.
- June 18, 2025. **COMPANY ADMIN APPLICATION WORKFLOW FIXED** - Resolved critical authentication and database issues preventing company admin (demoseven@yopmail.com) from accessing their applications. Fixed password hash validation, corrected requireAuth middleware to properly use session-based authentication, and added missing approval_status columns to database tables. Company admin can now successfully login, view applications list showing DEMO-001-101 (FRA application), and access individual application details with proper facility information and template status tracking. Authentication workflow now fully functional for existing company admin users.
- June 18, 2025. **SYSTEM ADMIN APPROVAL WORKFLOW SYSTEM COMPLETED** - Implemented comprehensive system admin interface with formal approval workflow for activity template submissions. Created AdminApplicationDetails.tsx for detailed application management with company/facility information, document access, and contractor assignment viewing. Created AdminApprovalDashboard.tsx for formal submission approval with filtering, search, quick approve, and detailed review capabilities including submission data preview and approval/rejection with review notes. Added backend storage methods getPendingSubmissions(), approveSubmission(), rejectSubmission(), getSubmissionDetails(), and getApplicationWithFullDetails() for complete approval system operations. Enhanced admin navigation with dedicated "Approvals" menu item. System admin can now view all applications system-wide, review submitted templates, and formally approve/reject submissions with detailed feedback and notification system.
- June 18, 2025. **NOTIFICATION TEMPLATE NAME RESOLUTION FIXED** - Resolved critical issue where contractor work completion notifications displayed "an activity" instead of specific template names. Root cause was backend getFormTemplates() returning empty array while frontend had template data available. Fixed by passing template name directly from frontend to notification API endpoint using templateName parameter. Notifications now correctly display specific template names like "TEst" and "PreActivity" when contractors complete work. Template name resolution now works reliably with frontend-to-backend data flow.
- June 18, 2025. **FINAL CONTRACTOR WORKFLOW OPTIMIZATIONS COMPLETED** - Completed all remaining contractor workflow improvements: (1) Enhanced notification template name resolution system to properly display specific template names from application_submissions table instead of generic "an activity" - now shows "TEst", "PreActivity" etc. in notifications when contractors complete work, (2) Removed overdue metrics box from contractor dashboard and implemented cleaner 2-column layout with "Completed" and "In Progress" metrics, (3) Fixed contractor completion status calculation to properly reflect company admin submission status rather than contractor saves, (4) Maintained contractor document visibility for company admins in main Documents tab, (5) Preserved contractor deduplication in applications list showing one entry per contracting company. Core contractor workflow now fully optimized with proper status tracking, clean dashboard UI, and accurate notification messaging system that references actual form template names.
- June 18, 2025. **CONTRACTOR WORKFLOW FINAL FIXES COMPLETED** - Fixed both remaining contractor workflow issues: (1) Enhanced notification system to display specific template names instead of generic "an activity" by implementing fallback logic to check both form_templates and activity_templates tables, (2) Implemented contractor document visibility for company admins by modifying getDocumentsByCompany() to include documents uploaded by contractors on company applications in the main Documents tab. Company admins now see contractor-uploaded files across all applications they own. Notification system now properly shows template names like "TEst" and "PreActivity" instead of generic messages. Document cross-visibility fully operational with proper SQL joins and deduplication.
- June 18, 2025. **CRITICAL CONTRACTOR APPLICATION PERSISTENCE BUG FIXED** - Resolved the major contractor application visibility issue where applications would disappear from account owner dashboards when team member assignments were removed. Implemented permanent historical tracking via `contractor_company_assignment_history` table that preserves company-level application assignments regardless of individual team member changes. Account owners now always see applications assigned to their contracting company, ensuring proper business continuity. Fixed PostgreSQL query result parsing to correctly handle database response structure. Complete contractor application management now functional with persistent visibility.
- June 18, 2025. **CONTRACTOR ROLE PERMISSIONS SYSTEM COMPLETED** - Fixed contractor team permission management to enable full administrative capabilities for account owners. Updated backend API endpoints to include `contractor_individual` role in all permission checks for assign/unassign/update operations. Corrected frontend display to show "Account Owner (Full Access)" instead of incorrect "view" permissions. Enhanced permission editing functionality for contractor account owners with `contractor_individual` role. Complete contractor team management now operational with proper role hierarchy recognition.
- June 17, 2025. **CONTRACTOR TEAM INVITATION EMAIL VERIFICATION FIX** - Fixed critical issue where invited contractor team members required email verification before login. Updated contractor team invitation endpoint to automatically set `isEmailVerified: true` and `emailVerifiedAt` for invited members. Contractor team members can now log in immediately after invitation without email verification step. Fixed existing contractor team member semiteammember47@yopmail.com login with Test1998* password. Complete contractor team invitation workflow now functional end-to-end.
- June 17, 2025. **CONTRACTOR APPLICATION VIEWING AND EDITING SYSTEM COMPLETED** - Implemented comprehensive contractor applications interface enabling contractors to view and edit assigned applications. Fixed contractor login authentication (semiteammember46@yopmail.com / Test1998*), resolved duplicate method issues in getContractorApplications API, and enhanced contractor dashboard with detailed application display. Contractors can now see assigned applications (TESACC-001-101) with facility info, company details, assignment permissions, and direct access to edit application forms. Complete contractor workflow now functional from login through application management.
- June 17, 2025. **CONTRACTOR ASSIGNMENT DUPLICATION ISSUE COMPLETELY RESOLVED** - Fixed critical bug where contractor assignments were accumulating duplicates instead of replacing existing assignments. Implemented proper `removeApplicationContractorAssignments` method in storage layer to clear existing assignments before adding new ones. Cleaned up 25+ duplicate assignment records from database for application TESACC-001-101. Assignment replacement logic now works correctly - selecting/deselecting contractors maintains clean list without duplicates.
- June 17, 2025. **CONTRACTOR SERVICES UPDATE PERMISSIONS FIXED** - Resolved permissions issue preventing contractor account owners from updating their services and regions. Fixed API endpoint to allow `contractor_individual` role (account owner) to edit services without requiring manager permissions. Added missing `capitalRetrofitTechnologies` variable to contractor registration endpoint. Contractor services page now fully functional for editing supported activities, service regions, and Capital Retrofit technology selections with proper code of conduct validation.
- June 17, 2025. **CONTRACTOR ASSIGNMENT SYSTEM ENHANCED WITH CR TECHNOLOGY MATCHING** - Added missing `/api/admin/contractors` endpoint to properly display all 6 registered contractors in admin portal. Enhanced Capital Retrofit activity filtering in ContractorAssignmentDialog to include sub-technology matching between facility requirements and contractor capabilities. Visual indicators now show matching CR technologies with green checkmarks and technology overlap counts. Admin contractors endpoint returns complete contractor data including supported activities, service regions, and capital retrofit technologies (Lighting, HVAC, Solar PV, etc.). Filtering logic now prioritizes contractors with matching CR technologies for more precise assignment recommendations.
- June 17, 2025. **CRITICAL API PARAMETER ORDER BUG FIXED** - Resolved system-wide API parameter order bug affecting all apiRequest calls throughout the application. Updated parameter sequence from incorrect (method, url, data) to correct (url, method, data) across all components including EnhancedFacilityForm.tsx, api.ts, NotificationBell.tsx, and application-details.tsx. This fix enables proper facility creation, team invitation, application form submission, and notification management. FRA application workflow now functions correctly with proper status progression: Draft → TEst Started → TEst Submitted → PreActivity Started.
- June 17, 2025. **COMPANY ADMIN TEAM INVITATION SYSTEM COMPLETED** - Removed role selection field from both modal and inline team invitation forms. All invited team members automatically receive "team_member" role with "viewer" permission level. Fixed critical API parameter order issue in TeamManagement.tsx where apiRequest calls used incorrect parameter sequence. Corrected all mutation functions (invite, transfer admin, permission updates, deactivation) to use proper (url, method, data) order. Simplified invitation form shows only essential fields: first name, last name, email, and optional message. Successfully tested end-to-end invitation flow with proper role assignment.
- June 17, 2025. **CONTRACTOR TEAM INVITATION SYSTEM COMPLETED** - Fixed all contractor team invitation and acceptance issues. Resolved email verification problems by automatically setting `isEmailVerified: true` for invited team members. Fixed invitation acceptance endpoint authentication issues and implemented proper bcrypt password hashing for new accounts. Complete invitation flow now works end-to-end: invitation creation with credentials → token-based acceptance → account creation with custom password → automatic login capability. All team members can now successfully join contractor teams through the invitation system.
- June 17, 2025. **CONTRACTOR TEAM MANAGEMENT SYSTEM FULLY OPERATIONAL** - Completed comprehensive contractor team management with full administrative capabilities. Fixed contractor dashboard routing to recognize all contractor role types (contractor_account_owner, contractor_manager, contractor_team_member), restored sidebar navigation menu, and resolved API authentication issues. Implemented complete team management interface with permission editing, ownership transfer with warning dialogs, member removal, and invitation acceptance/decline functionality. Account owners can now manage all team operations including transferring ownership (with role demotion warnings), editing member permissions, and handling team invitations. All contractor role types properly recognized across frontend routing, sidebar navigation, and backend API endpoints.
- June 17, 2025. **DATABASE SCHEMA SYNCHRONIZATION COMPLETED** - Resolved critical database schema mismatches in contractor team system. Updated teamInvitations table schema to use `invitedByUserId` column matching actual database structure, manually added missing contractor role enum values to PostgreSQL database, and fixed storage layer column mappings. Contractor user roles now properly assigned with VfsDO1UpkgLy1qVevGIMt updated to contractor_account_owner for company 29 and 4sQP3JUM9WuK69i2TCZsq updated to contractor_account_owner for company 30.
- June 17, 2025. **SERVICES & REGIONS PAGE ENHANCED** - Fixed checkbox state issues where currently supported activities now properly show as checked when editing. Added Capital Retrofit sub-options with 11 technology categories (Lighting, Solar PV, HVAC, Process Heating, Geothermal, Process Cooling and Refrigeration, Pump Driven Systems, Fan Driven Systems, Compressed Air, Building Envelope, Other). Updated database schema with `capital_retrofit_technologies` column and enhanced backend API to support technology storage. Improved form state management and display logic to show selected technologies under Capital Retrofit. Fixed API request parameter ordering bug in queryClient.
- June 16, 2025. **CONTRACTOR DASHBOARD RESTRUCTURED** - Completely restructured contractor dashboard with sidebar navigation replacing main page menu items. Created separate dedicated contractor pages: Applications, Services & Regions, Team Management, and Profile. Removed documents section from contractor dashboard. Updated contractor visibility status to read-only display for contractors with admin-side control for activation/deactivation via `/api/admin/contractors/:id/toggle-status` endpoint. Profile management moved to top-right dropdown. Fixed contractor applications API database error by correcting table reference from contractorAssignments to applicationAssignments.
- June 16, 2025. **CONTRACTOR REGISTRATION FULLY RESOLVED** - Fixed multiple issues: (1) Frontend form missing `codeOfConductAgreed` and `gstWcbInsuranceConfirmed` fields in data sent to backend, (2) Backend validation incorrectly requiring postal codes for contractors, (3) Contractor role assignment and dashboard redirection, (4) Company short name collision detection for unique identifiers. Complete contractor registration flow now working end-to-end.
- June 13, 2025. Initial setup

## User Preferences

Preferred communication style: Simple, everyday language.